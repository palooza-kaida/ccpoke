<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ccbot ‚Äî Response</title>
  <meta name="description" content="Claude Code response viewer ‚Äî ccbot">
  <link rel="icon" type="image/svg+xml" sizes="any" href="logo.svg?v=3">
  <link rel="apple-touch-icon" href="logo.svg?v=3">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/styles/github-dark.min.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <style type="text/tailwindcss">
    @theme {
      --color-bg: #FFFFFF;
      --color-bg-warm: #FAF9F7;
      --color-bg-code: #1A1A2E;
      --color-bg-code-2: #222239;
      --color-txt: #1A1A2E;
      --color-txt-2: #5A5A72;
      --color-txt-3: #8E8E9F;
      --color-accent: #D97757;
      --color-accent-hover: #C4623F;
      --color-accent-light: #FFF0EB;
      --color-emerald: #2E8B57;
      --color-emerald-light: #E8F5EE;
      --color-sky: #4A7FD4;
      --color-sky-light: #EBF2FC;
      --color-plum: #7C5CBF;
      --color-plum-light: #F1ECF9;
      --color-border: #EBEBEB;
      --color-term-text: #E0E0E0;
      --font-sans: 'Inter', system-ui, -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      --max-width-content: 780px;
    }

    html { scroll-behavior: smooth; }
    body {
      font-family: var(--font-sans);
      background: var(--color-bg);
      color: var(--color-txt);
      line-height: 1.625;
      -webkit-font-smoothing: antialiased;
    }
    a { color: var(--color-accent); text-decoration: none; transition: color 0.15s; }
    a:hover { color: var(--color-accent-hover); }


    .md-body h1 {
      font-size: 1.5rem; font-weight: 800; margin: 28px 0 12px;
      padding-bottom: 10px; border-bottom: 2px solid var(--color-border);
      color: var(--color-txt); letter-spacing: -0.02em;
    }
    .md-body h2 {
      font-size: 1.25rem; font-weight: 700; margin: 24px 0 10px;
      color: var(--color-txt); letter-spacing: -0.01em;
    }
    .md-body h3 {
      font-size: 1.05rem; font-weight: 700; margin: 20px 0 8px;
      color: var(--color-txt);
    }
    .md-body p { margin: 0 0 14px; color: var(--color-txt-2); }
    .md-body a { color: var(--color-accent); }
    .md-body a:hover { color: var(--color-accent-hover); text-decoration: underline; }
    .md-body strong { color: var(--color-txt); font-weight: 700; }
    .md-body em { color: var(--color-txt-2); }
    .md-body ul, .md-body ol { margin: 0 0 14px; padding-left: 24px; color: var(--color-txt-2); }
    .md-body li { margin-bottom: 4px; }
    .md-body li::marker { color: var(--color-accent); }
    .md-body code {
      font-family: var(--font-mono); font-size: 0.82em;
      background: var(--color-bg-warm); color: var(--color-accent);
      padding: 2px 7px; border-radius: 5px; border: 1px solid var(--color-border);
    }
    .md-body pre {
      margin: 0 0 16px; border-radius: 12px; overflow: hidden;
      background: var(--color-bg-code);
    }
    .md-body pre code {
      display: block; padding: 18px 20px; font-size: 0.8rem; line-height: 1.65;
      background: var(--color-bg-code); border: none; overflow-x: auto;
      color: var(--color-term-text);
    }
    .md-body blockquote {
      margin: 0 0 14px; padding: 12px 18px;
      border-left: 3px solid var(--color-accent); background: var(--color-accent-light);
      border-radius: 0 10px 10px 0; color: var(--color-txt-2);
    }
    .md-body blockquote p:last-child { margin: 0; }
    .md-body table { width: 100%; margin: 0 0 16px; border-collapse: collapse; font-size: 0.85rem; }
    .md-body th {
      background: var(--color-bg-warm); font-weight: 700; text-align: left;
      padding: 10px 14px; border: 1px solid var(--color-border); color: var(--color-txt);
    }
    .md-body td { padding: 8px 14px; border: 1px solid var(--color-border); color: var(--color-txt-2); }
    .md-body hr { margin: 24px 0; border: none; border-top: 1px solid var(--color-border); }
    .md-body img { max-width: 100%; border-radius: 12px; }

    @keyframes spin { to { transform: rotate(360deg); } }

    @media (max-width: 700px) {
      body { font-size: 0.9rem; }
      .md-body { font-size: 0.88rem; }
      .md-body h1 { font-size: 1.3rem; }
      .md-body h2 { font-size: 1.12rem; }
      .md-body pre code { font-size: 0.75rem; padding: 14px 16px; }
    }

    @media (prefers-reduced-motion: reduce) {
      html { scroll-behavior: auto; }
    }
  </style>
</head>
<body class="min-h-screen">
  <nav class="sticky top-0 z-[100] bg-white/85 backdrop-blur-[12px] border-b border-border">
    <div class="max-w-content mx-auto px-6 h-14 flex items-center gap-2.5">
      <a href="./" class="flex items-center gap-1.5 no-underline text-txt">
        <img src="logo.svg" alt="ccbot logo" class="w-8 h-8">
        <span class="font-bold text-base tracking-tight">ccbot</span>
      </a>
      <span class="ml-auto text-[0.78rem] font-medium text-txt-3" id="headerTime"></span>
    </div>
  </nav>

  <div class="flex items-center gap-3 px-6 py-3 bg-bg-warm border-b border-border flex-wrap" id="metaBar" style="display:none">
    <div class="flex items-center gap-1.5 text-[0.82rem] text-txt-2">
      <span class="text-[0.92rem]">üìÇ</span>
      <span class="font-semibold text-accent font-mono text-[0.82rem]" id="metaProject"></span>
    </div>
    <div class="flex items-center" id="metaDurationWrap" style="display:none">
      <span class="px-3 py-0.5 bg-accent-light rounded-full text-accent font-semibold text-[0.75rem]" id="metaDuration"></span>
    </div>
  </div>

  <main class="max-w-content mx-auto px-6 py-7 pb-16">

    <div id="loading" class="flex flex-col items-center justify-center min-h-[60vh] text-center py-10">
      <div class="w-8 h-8 border-3 border-border border-t-accent rounded-full animate-spin mb-4" style="animation: spin 0.8s linear infinite;"></div>
      <div class="text-[0.88rem] text-txt-3" data-i18n="loading">Loading response...</div>
    </div>

    <div id="error" class="flex flex-col items-center justify-center min-h-[60vh] text-center py-10" style="display:none">
      <div class="text-3xl mb-3">‚ö†Ô∏è</div>
      <div class="text-[0.88rem] text-txt-3" id="errorText" data-i18n="notFound">Response not found</div>
    </div>

    <div id="responseContent" style="display:none">
      <div class="md-body text-[0.92rem] leading-[1.75]" id="markdownBody"></div>

      <div class="mt-6 p-5 bg-bg-warm rounded-xl border border-border" id="gitChanges" style="display:none">
        <div class="text-[0.82rem] font-bold text-txt mb-2.5 flex items-center gap-1.5" data-i18n="changes">üìÇ Changes</div>
        <div id="gitFileList" class="flex flex-col"></div>
      </div>
    </div>

  </main>


  <footer class="py-8 text-center border-t border-border mt-1">
    <div class="max-w-content mx-auto px-6">
      <p class="text-[0.82rem] text-txt-3">MIT &middot; TypeScript &middot; <a href="https://github.com/palooza-kaida/ccbot" class="text-txt-3 hover:text-txt-2">github.com/palooza-kaida/ccbot</a></p>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/marked@15/lib/marked.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.11.1/build/highlight.min.js"></script>
  <script>
    if (window.Telegram && Telegram.WebApp) {
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();
    }

    const RESP_I18N = {
      en: { loading: 'Loading response...', notFound: 'Response not found', notFoundExpired: 'Response not found or expired', loadFailed: 'Failed to load response', invalidData: 'Invalid response data', noData: 'No response data provided', changes: 'üìÇ Changes', expired: 'Response data has expired. Basic info is shown above.' },
      vi: { loading: 'ƒêang t·∫£i response...', notFound: 'Kh√¥ng t√¨m th·∫•y response', notFoundExpired: 'Response kh√¥ng t√¨m th·∫•y ho·∫∑c ƒë√£ h·∫øt h·∫°n', loadFailed: 'T·∫£i response th·∫•t b·∫°i', invalidData: 'D·ªØ li·ªáu response kh√¥ng h·ª£p l·ªá', noData: 'Kh√¥ng c√≥ d·ªØ li·ªáu response', changes: 'üìÇ Thay ƒë·ªïi', expired: 'D·ªØ li·ªáu response ƒë√£ h·∫øt h·∫°n. Th√¥ng tin c∆° b·∫£n hi·ªÉn th·ªã ·ªü tr√™n.' },
      zh: { loading: 'Ê≠£Âú®Âä†ËΩΩÂìçÂ∫î...', notFound: 'Êú™ÊâæÂà∞ÂìçÂ∫î', notFoundExpired: 'ÂìçÂ∫îÊú™ÊâæÂà∞ÊàñÂ∑≤ËøáÊúü', loadFailed: 'Âä†ËΩΩÂìçÂ∫îÂ§±Ë¥•', invalidData: 'Êó†ÊïàÁöÑÂìçÂ∫îÊï∞ÊçÆ', noData: 'Êú™Êèê‰æõÂìçÂ∫îÊï∞ÊçÆ', changes: 'üìÇ ÂèòÊõ¥', expired: 'ÂìçÂ∫îÊï∞ÊçÆÂ∑≤ËøáÊúü„ÄÇÂü∫Êú¨‰ø°ÊÅØÊòæÁ§∫Âú®‰∏äÊñπ„ÄÇ' },
    };

    function detectRespLocale() {
      const saved = localStorage.getItem('ccbot-locale');
      if (saved && RESP_I18N[saved]) return saved;
      const nav = navigator.language?.slice(0, 2);
      if (nav === 'zh') return 'zh';
      if (nav === 'vi') return 'vi';
      return 'en';
    }

    const respLang = detectRespLocale();
    const rt = RESP_I18N[respLang];

    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (rt[key]) el.textContent = rt[key];
    });

    marked.setOptions({
      highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
          return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
      },
      breaks: true,
      gfm: true,
    });

    const statusMap = {
      added:    { label: 'A', cls: 'bg-emerald-light text-emerald' },
      deleted:  { label: 'D', cls: 'bg-[#FDECEC] text-[#C53030]' },
      modified: { label: 'M', cls: 'bg-accent-light text-accent' },
      renamed:  { label: 'R', cls: 'bg-plum-light text-plum' },
    };

    function formatDuration(ms) {
      const s = Math.floor(ms / 1000);
      if (s < 60) return s + 's';
      return Math.floor(s / 60) + 'm' + (s % 60) + 's';
    }

    function renderBasicInfo(hashData) {
      if (hashData.p) {
        document.getElementById('metaBar').style.display = 'flex';
        document.getElementById('metaProject').textContent = hashData.p;
      }
      if (hashData.d > 0) {
        document.getElementById('metaDurationWrap').style.display = 'flex';
        document.getElementById('metaDuration').textContent = '‚è± ' + formatDuration(hashData.d);
      }
    }

    function renderResponse(data) {
      document.getElementById('loading').style.display = 'none';

      document.getElementById('responseContent').style.display = 'block';

      if (data.projectName) {
        document.getElementById('metaBar').style.display = 'flex';
        document.getElementById('metaProject').textContent = data.projectName;
      }
      if (data.durationMs > 0) {
        document.getElementById('metaDurationWrap').style.display = 'flex';
        document.getElementById('metaDuration').textContent = '‚è± ' + formatDuration(data.durationMs);
      }

      if (data.responseSummary) {
        document.getElementById('markdownBody').innerHTML = marked.parse(data.responseSummary);
        document.querySelectorAll('.md-body pre code').forEach(block => {
          hljs.highlightElement(block);
        });
      }

      if (data.gitChanges && data.gitChanges.length > 0) {
        const container = document.getElementById('gitChanges');
        const list = document.getElementById('gitFileList');
        container.style.display = 'block';

        for (const change of data.gitChanges) {
          const s = statusMap[change.status] || statusMap.modified;
          const div = document.createElement('div');
          div.className = 'flex items-center gap-2 py-1.5 font-mono text-[0.78rem] text-txt-2 border-b border-border last:border-b-0';
          div.innerHTML = `<span class="text-[0.72rem] px-2 py-0.5 rounded font-bold font-sans tracking-wide ${s.cls}">${s.label}</span><span>${change.file}</span>`;
          list.appendChild(div);
        }
      }

      if (data.timestamp) {
        document.getElementById('headerTime').textContent = new Date(data.timestamp).toLocaleString();
      }
    }

    function showError(msg) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      document.getElementById('errorText').textContent = msg;
    }

    function showExpired() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'flex';
      document.getElementById('errorText').textContent = rt.expired;
    }

    async function init() {
      const params = new URLSearchParams(window.location.search);
      const paramId = params.get('id');
      const paramApi = params.get('api');

      if (!paramId || !paramApi) {
        showError(rt.noData);
        return;
      }

      renderBasicInfo({ p: params.get('p') || '', d: parseInt(params.get('d') || '0', 10) });

      try {
        const res = await fetch(`${paramApi}/api/responses/${paramId}`);
        if (!res.ok) {
          showExpired();
          return;
        }
        const data = await res.json();
        renderResponse(data);
      } catch (e) {
        showExpired();
      }
    }

    init();
  </script>

</body>
</html>
