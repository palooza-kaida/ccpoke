---
import { ts, SUPPORTED_LOCALES, LOCALE_LABELS, DEFAULT_LOCALE, type Locale } from "../i18n";
import { icons } from "../assets/icons";

interface Props {
  locale: Locale;
  currentPath?: string;
  showSectionNav?: boolean;
}

const { locale, currentPath = "/", showSectionNav = false } = Astro.props;
const base = import.meta.env.BASE_URL;

function localePageHref(loc: Locale, path: string): string {
  const cleanPath = path === "/" ? "" : path;
  if (loc === DEFAULT_LOCALE) return `${base}${cleanPath ? cleanPath.slice(1) + "/" : ""}`;
  return `${base}${loc}${cleanPath}/`;
}

const navLinks = [
  { key: "navHow", hash: "#how" },
  { key: "navFeatures", hash: "#features" },
  { key: "navSetup", hash: "#setup" },
  { key: "navRoadmap", hash: "#roadmap" },
];
---

<nav class="sticky top-0 z-[100] bg-white/85 backdrop-blur-[12px] border-b border-border">
  <div class="max-w-content mx-auto px-6 h-14 flex items-center gap-6">
    <a href={localePageHref(locale, "/")} class="flex items-center gap-1.5 no-underline text-txt shrink-0">
      <span class="w-8 h-8 block [&>svg]:w-full [&>svg]:h-full" set:html={icons.logoFilled} />
      <span class="font-bold text-base tracking-tight">ccpoke</span>
    </a>

    {showSectionNav && (
      <div class="flex items-center gap-5 ml-auto nav-hide-mobile">
        {navLinks.map(({ key, hash }) => (
          <a href={hash} class="text-[0.78rem] font-semibold text-txt-2 no-underline hover:text-txt transition-colors duration-150">
            {ts(locale, key)}
          </a>
        ))}
      </div>
    )}

    <div class="flex items-center gap-2 ml-auto">
      <a href={localePageHref(locale, "/brand")} class="text-[0.78rem] font-semibold text-txt-2 no-underline hover:text-txt transition-colors duration-150 nav-hide-mobile">
        {ts(locale, "navBrand")}
      </a>
      <div class="lang-dropdown" id="langDropdown">
        <button class="lang-trigger" id="langTrigger" type="button" aria-label="Language">
          <span id="langCurrent">{LOCALE_LABELS[locale]}</span>
          <Fragment set:html={icons.chevronDown} />
        </button>
        <div class="lang-menu">
          {SUPPORTED_LOCALES.map((loc) => (
            <a
              href={localePageHref(loc, currentPath)}
              class:list={["lang-option", { active: loc === locale }]}
              data-locale={loc}
            >
              {LOCALE_LABELS[loc]}
            </a>
          ))}
        </div>
      </div>

      <a href="https://github.com/palooza-kaida/ccpoke" target="_blank" rel="noopener"
        class="text-txt-3 hover:text-txt transition-colors duration-150 nav-hide-mobile flex items-center" aria-label="GitHub">
        <span class="w-5 h-5" set:html={icons.github} />
      </a>

      {showSectionNav && (
        <button class="mob-menu-btn" id="mobMenuBtn" type="button" aria-label="Menu">
          <Fragment set:html={icons.menu} />
        </button>
      )}
    </div>
  </div>
</nav>

{showSectionNav && (
  <div class="mob-nav-overlay" id="mobOverlay"></div>
  <div class="mob-nav-panel" id="mobPanel">
    <button class="mob-nav-close" id="mobClose" type="button" aria-label="Close">
      <Fragment set:html={icons.close} />
    </button>
    {navLinks.map(({ key, hash }) => (
      <a href={hash} class="mob-nav-link">{ts(locale, key)}</a>
    ))}
    <a href={localePageHref(locale, "/brand")} class="mob-nav-link">{ts(locale, "navBrand")}</a>
  </div>
)}

<script>
  import { setStorage } from "../utils/storage";

  const langDropdown = document.getElementById("langDropdown");
  const langTrigger = document.getElementById("langTrigger");
  langTrigger?.addEventListener("click", () => langDropdown?.classList.toggle("open"));
  document.addEventListener("click", (e) => {
    if (!langDropdown?.contains(e.target as Node)) langDropdown?.classList.remove("open");
  });

  document.querySelectorAll(".lang-option").forEach((el) => {
    el.addEventListener("click", (e) => {
      const locale = (el as HTMLElement).dataset.locale;
      if (locale) setStorage("locale", locale);

      const query = window.location.search;
      if (query) {
        e.preventDefault();
        window.location.href = (el as HTMLAnchorElement).href + query;
      }
    });
  });

  const mobMenuBtn = document.getElementById("mobMenuBtn");
  const mobOverlay = document.getElementById("mobOverlay");
  const mobClose = document.getElementById("mobClose");
  const mobPanel = document.getElementById("mobPanel");

  function openMobMenu() {
    mobOverlay?.classList.add("open");
    mobPanel?.classList.add("open");
  }
  function closeMobMenu() {
    mobOverlay?.classList.remove("open");
    mobPanel?.classList.remove("open");
  }

  mobMenuBtn?.addEventListener("click", openMobMenu);
  mobOverlay?.addEventListener("click", closeMobMenu);
  mobClose?.addEventListener("click", closeMobMenu);
  mobPanel?.querySelectorAll("a").forEach((a) => a.addEventListener("click", closeMobMenu));
</script>
